package io.github.luminsyn.autoconfigure.aop.spi.writer;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import org.aspectj.lang.reflect.MethodSignature;
import org.slf4j.event.Level;
import org.springframework.core.env.Environment;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.JavaMailSenderImpl;
import org.springframework.mail.javamail.MimeMessageHelper;

import java.io.PrintWriter;
import java.io.StringWriter;

/**
 * An extension of RequestLogWriter that sends an email when an error occurs.
 *
 * @author luminsyn
 */
public class EmailLogWriter extends RequestLogWriter {

    private final String[] to;
    private final JavaMailSender mailSender;
    private final String from;
    private final Environment environment;


    public EmailLogWriter(Level level, JavaMailSender mailSender, String from, Environment environment, String... to) {
        super(level);
        this.to = to;
        this.mailSender = mailSender;
        this.from = from;
        this.environment = environment;
    }

    @Override
    public void error(Object target, MethodSignature signature, Object[] args, Throwable throwable, long duration) {
        // First, log the error using the parent's implementation
        super.error(target, signature, args, throwable, duration);

        // Then, send an email with the error details
        sendErrorEmail(signature, args, throwable, duration);
    }

    /**
     * Sends an email with details about the error.
     *
     * @param signature the method signature
     * @param args      the method arguments
     * @param throwable the exception that was thrown
     * @param duration  the duration of the method execution
     */
    private void sendErrorEmail(MethodSignature signature, Object[] args, Throwable throwable, long duration) {
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
            helper.setFrom(from);
            helper.setTo(to);

            String appName = environment != null ? environment.getProperty("spring.application.name", "N/A") : "N/A";
            helper.setSubject(String.format("⚠️ Exception in %s: %s", appName, getMethodName(signature)));

            StringWriter sw = new StringWriter();
            PrintWriter pw = new PrintWriter(sw);
            throwable.printStackTrace(pw);
            String stackTrace = sw.toString();

            String port = environment != null ? environment.getProperty("server.port", "N/A") : "N/A";

            String body = buildHtmlEmailBody(
                appName,
                port,
                getRequestInfo(),
                getMethodName(signature),
                formatArgs(signature.getParameterNames(), args),
                duration,
                stackTrace
            );

            helper.setText(body, true);
            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            // Log the exception that occurred while sending email
            System.err.println("Error sending email notification: " + e.getMessage());
        }
    }

    private String buildHtmlEmailBody(String appName, String port, String requestInfo, String methodName, String methodArgs, long duration, String stackTrace) {
        return "<!DOCTYPE html>" +
               "<html>" +
               "<head>" +
               "<style>" +
               "body {font-family: Arial, sans-serif; margin: 20px; color: #333;}" +
               "h2 {color: #D32F2F; border-bottom: 2px solid #f2f2f2; padding-bottom: 10px;}" +
               "table {border-collapse: collapse; width: 100%; margin-top: 20px; border: 1px solid #ddd;}" +
               "th, td {text-align: left; padding: 12px; border-bottom: 1px solid #ddd;}" +
               "th {background-color: #f8f8f8; font-weight: bold; width: 120px;}" +
               "pre {white-space: pre-wrap; word-wrap: break-word; background-color: #f5f5f5; padding: 15px; border-radius: 4px; border: 1px solid #ccc; font-family: 'Courier New', Courier, monospace;}" +
               "</style>" +
               "</head>" +
               "<body>" +
               "<h2>Application Error Report</h2>" +
               "<table>" +
               "<tr><th>Application</th><td>" + appName + "</td></tr>" +
               "<tr><th>Port</th><td>" + port + "</td></tr>" +
               "<tr><th>Request</th><td>" + requestInfo.replace(" -", "") + "</td></tr>" +
               "<tr><th>Method</th><td>" + methodName + "</td></tr>" +
               "<tr><th>Arguments</th><td>" + methodArgs + "</td></tr>" +
               "<tr><th>Duration</th><td>" + duration + " ms</td></tr>" +
               "</table>" +
               "<h3>Stack Trace</h3>" +
               "<pre>" + stackTrace + "</pre>" +
               "</body>" +
               "</html>";
    }


    public static void main(String[] args) throws Exception {
        JavaMailSenderImpl javaMailSender = new JavaMailSenderImpl();
        javaMailSender.setHost("smtp.163.com");
        javaMailSender.setUsername("luminsyn@163.com");
        javaMailSender.setPassword(System.getProperty("163_MAIL_PWD")); 

        MimeMessage mimeMessage = javaMailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, "UTF-8");
        helper.setFrom("luminsyn@163.com");
        helper.setTo("luminsyn@qq.com"); // 收件人

        // --- 用于邮件正文的示例数据 ---
        String appName = "order-service";
        String port = "8081";
        String requestInfo = "192.168.1.100 POST /api/orders";
        String methodName = "placeOrder";
        String methodArgs = "customer=123, items=[7, 8]";
        long duration = 250;
        String stackTrace = "java.lang.IllegalStateException: Insufficient stock for item 7\n" +
                            "\tat com.example.service.OrderService.createOrder(OrderService.java:115)\n" +
                            "\tat com.example.controller.OrderController.placeOrder(OrderController.java:52)\n" +
                            "\t... (full stack trace)";

        helper.setSubject(String.format("⚠️ Exception in %s: %s", appName, methodName));

        String body = new EmailLogWriter(null, null, null, null)
                .buildHtmlEmailBody(appName, port, requestInfo, methodName, methodArgs, duration, stackTrace);

        helper.setText(body, true);
        javaMailSender.send(mimeMessage);
        System.out.println("Test email sent successfully!");
    }
}
